Алгоритм определения выбивания игрока по истории раздачи (GG Poker)
Теоретическое описание критериев выбивания
В контексте турниров по покеру выбивание (нокаут) происходит, когда игрок теряет все свои фишки в раздаче и вылетает из турнира. Наша цель – определить, выбил ли конкретный игрок (далее Hero) другого игрока в данной раздаче по ее истории (hand history). Для этого необходимо учитывать следующие критерии:
Факт вылета оппонента: Оппонент считается выбитым, если по окончании раздачи его стек равен 0 (он потерял все фишки) и он не продолжает игру (не осталось фишек и нет реэнтри).
Участие Hero в выбивании: Hero должен быть непосредственным победителем тех фишек, которые принадлежали вылетевшему оппоненту. Иными словами, фишки оппонента, ушедшего в олл-ин, должны оказаться в банке(ах), выигранном(ых) Hero (полностью или частично). Если Hero не получил ни одной фишки оппонента, значит, оппонента выбил кто-то другой.
Мультипоты и сайд-поты: В многосторонних раздачах (3+ игрока) с олл-инами оппонента могут образовываться несколько банков – основной (main pot) и один или несколько побочных (side pot). В таких случаях выбивание засчитывается Hero, если Hero является победителем  банка, в который оппонент вложил свои последние фишки, и при этом оппонент не выиграл ни один другой банк (проиграл все свои фишки). Даже если банк делится между несколькими игроками (split pot), участие Hero в разделе банка, содержащего фишки вылетевшего, означает, что Hero причастен к выбиванию.
Различие стеков (stack coverage): Необходимо учитывать, у кого сколько фишек относительно друг друга. Кто “покрывает” кого по стеку, определяет размер возможных банков и участие в них. Если оппонент имел самый маленький стек и пошел олл-ин, его фишки окажутся только в основном банке. Если у оппонента был средний стек, часть его фишек может участвовать в основном банке (до размера самого маленького олл-ина), а остаток – в сайд-поте с более крупными стеками. Алгоритм должен отследить, в какой банк оппонент вложил свои последние фишки.
Окончательный исход раздачи: Решение о выбивании принимается только после завершения раздачи (шоудауна или ситуации, когда все остальные сдались). Неважно, на какой улице произошел олл-ин – префлоп, флоп, терн или ривер – важно, что по итогам раздачи оппонент выбыл, а Hero получил часть его фишек. Например, если оппонент выставился на флопе, но остальные доиграли раздачу до ривера (разыгрывая сайд-пот), мы определяем факт выбивания только после выяснения результатов на шоудауне.
Авто-олл-ин (forced all-in): Если оппонент оказался олл-ин автоматически (например, у него был очень короткий стек, и он вынужденно выставился, поставив блайнд или анте), это тоже рассматривается как олл-ин. Алгоритм должен учитывать такие случаи: оппонент, поставивший последние фишки в блайнды/анте, участвует в банке на тех же правах, что и олл-ин, и если он проиграл и выбыл, а Hero выиграл этот банк – это выбивание, совершаемое Hero.
Формат турнира: Алгоритм применяется в турнирах любого типа (обычные, PKO и др.). Мы фиксируем сам факт выбивания, независимо от того, есть ли награда за нокаут. (В PKO-турнирах обычно полагается баунти за выбитого; наш критерий позволяет определить, должен ли Hero получить баунти, но сам алгоритм одинаков для всех турниров.)
Важно: если в раздаче никто не потерял все фишки, выбивания нет. Также, если Hero сам проиграл все фишки, он не мог никого выбить в этой раздаче (поскольку не выиграл фишки оппонента). Алгоритм фокусируется на случаях, где Hero – победитель фишек оппонента, который выбыл.
Возможные особые случаи (Edge cases)
При анализе hand history для выявления выбиваний нужно обратить внимание на ряд нестандартных ситуаций и убедиться, что алгоритм их корректно обрабатывает:
Многосторонние олл-ины и сайд-поты: Когда в раздаче участвуют 3 и более игроков и несколько из них идут олл-ин с разными стеками, формируется основной банк и один или несколько сайд-потов. В таких ситуациях возможно выбивание нескольких игроков одновременно. Алгоритм должен поддерживать выявление каждого выбитого оппонента и определять, получил ли Hero фишки каждого из них. Например, если три игрока (включая Hero) выставились, и у всех разные стеки, то могут вылететь сразу два оппонента – нужно проверить, достались ли фишки каждого из них Hero (Hero мог выиграть все банки или только один из них).
Split-pot (дележка банка): Ситуация, когда банк делится между несколькими победителями (например, при равных комбинациях). Особый случай – дележка банка, в который вложены фишки олл-ин оппонента. Если оппонент с худшей комбинацией выбывает, а банк с его фишками поделили, каждый участник дележки, получивший часть этого банка, считается выбившим оппонента. Алгоритм должен учитывать, что при split-pot выбивание может засчитаться нескольким игрокам. Например, оппонент A пошел олл-ин, Hero и другой игрок B имеют одинаково сильную руку сильнее, чем у A, и поделили выигранные фишки – в результате A выбыл, и оба (Hero и B) участвовали в его выбивании.
Выставление на разных улицах: Раздача может развиваться с поэтапными олл-инами. Один игрок может пойти олл-ин уже на флопе, а оставшиеся двое продолжат торги и, скажем, еще один олл-ин случится на терне. В итоге формируется основной банк (между всеми, кто был на флопе) и сайд-пот (между теми, кто продолжил игру после флопа). Алгоритм должен корректно обработать последовательные олл-ины: оппонент, выставившийся раньше, ждет шоудауна, пока другие разыгрывают сайд-пот. Мы должны по итогам раздачи определить, вылетел ли этот оппонент и получил ли Hero его фишки. При любом количестве олл-инов на разных этапах алгоритм распределения банков и выявление победителя каждого банка остаются такими же.
Авто-олл-ин короткого стека: Особый случай олл-ина – игрок, у которого стек меньше обязательной ставки (блайнда или анте), автоматически ставит все фишки. Например, если big blind 1000, а у игрока только 300, то эти 300 идут в банк, и он считается олл-ин на префлопе. Для алгоритма это означает, что этот игрок участвует в основном банке с 300, а разница (если другие игроки продолжат торги до 1000) пойдет в сайд-пот, в котором короткого стека нет. Мы должны проверить, не выиграл ли Hero этот основной банк с 300 – если да и короткий стек выбыл, то Hero его выбил. Аналогично с анте: если у игрока хватает фишек только на анте, он ставит их и фактически олл-ин; если он проигрывает, тот, кто забрал этот банк (часто просто все активные игроки делят, если никто больше не поставил), будет выбившим.
Несколько выбивших и несколько выбывших: В одной раздаче может вылететь несколько игроков, и разные банки могут выиграть разные победители. Алгоритм должен учесть для каждого выбывшего игрока отдельно, причастен ли Hero к его выбиванию. Например, в тройном олл-ине: у игрока A 10BB, у Hero 20BB, у игрока B 30BB. Все выставились; возможен исход, где Hero выиграл основной банк (выбив A), но проиграл сайд-пот игроку B (B сохранил часть фишек и остался в игре). В таком случае A выбыл – и его выбил Hero, а игрок B не выбыл (он даже увеличил стек за счет сайд-пота). Алгоритм должен зафиксировать, что Hero выбил A, несмотря на то что Hero проиграл часть своих фишек B.
Выбивание при отрицательном профите: Связанно с предыдущим – Hero может номинально проиграть фишки в раздаче (в целом снизить свой стек), но при этом выбить одного из оппонентов. Главное – факт, что Hero выиграл банк с фишками оппонента, который в итоге выбыл. Например, Hero и два соперника идут олл-ин, Hero победил меньший стек и проиграл большему: в итоге у Hero стало меньше фишек, чем было, но один оппонент все равно выбыл по вине Hero. Такой случай тоже должен фиксироваться как выбивание.
Hero не участвовал в шоудауне: Если Hero сбросил карты и не дошел до шоудауна, он не мог выиграть ни одного банка, следовательно, не мог никого выбить. Алгоритм должен избегать ложного срабатывания, например, если оппонент вылетел, но банк забрал другой игрок (не Hero). Только победа Hero в соответствующем банке может привести к выбиванию.

Перечисленные нюансы нужно учесть при разработке алгоритма, чтобы он правильно определял выбивания во всех сложных случаях.

Примеры ситуаций
Рассмотрим разнообразные примеры раздач, иллюстрирующие работу алгоритма в описанных случаях. В каждом примере укажем начальные стеки, ход раздачи и итог, а также поясним, кого выбил Hero (если выбил).
Пример 1: Heads-up олл-ин (простая ситуация)
Ситуация: Турнирная раздача, остались только Hero и один оппонент. Перед раздачей у Hero, скажем, 50 BB, у оппонента 10 BB. Оппонент пушит (олл-ин) префлоп на 10 BB, Hero коллирует. Больше никого нет, формируется один основной банк в 20 BB. Карты вскрываются на шоудауне. Результат: Если комбинация Hero сильнее, Hero выигрывает банк 20 BB. Оппонент теряет свои 10 BB и остается с 0 – он выбыл. Все фишки оппонента оказались у Hero, значит Hero выбил оппонента. Комментарий: Это базовый случай: heads-up олл-ин, победитель забирает все, проигравший выбыл. Алгоритм должен правильно определить, что выбывший оппонент вложил все свои фишки в основной банк, и этот банк выиграл Hero. Следовательно, Hero причастен к выбиванию.
Пример 2: Мультипот префлоп с двумя выбиваниями
Ситуация: На префлопе сразу три игрока идут олл-ин:
Hero (большой стек) – 10000 фишек,
Оппонент A – 5000 фишек,
Оппонент B – 2000 фишек.
Все фишки оказываются в центре. Поскольку стеки разные, образуются несколько банков:
Основной банк: формируется из вклада самого маленького стека (B) по 2000 от каждого участника. Итого размер основного банка = 2000 * 3 = 6000, его разыгрывают A, B и Hero.
Сайд-пот 1: у A осталось ещё 3000 (до его 5000) сверх вклада B, у Hero можно сопоставить эти 3000. Оппонент B больше не участвует (он вложил всё в основной). Сайд-пот1 = 3000 от A + 3000 от Hero = 6000, его разыгрывают A и Hero.
У Hero после этого всё ещё остаётся 10000 - 5000 = 5000 фишек, которые он не ставил (он покрывал всех и не отдал весь стек).
Распределение: Теперь два банка:
Основной (6000) – между троими.
Сайд-пот1 (6000) – между Hero и A.
Предположим, на шоудауне карты показываются:
У Hero лучшая комбинация из всех троих.
У A вторая по силе.
У B – самая слабая.
Результат: Hero выигрывает оба банка (и основной, и сайд-пот1), поскольку у него лучшая рука. Он забирает все 12000 фишек, что были в игре, увеличив стек до 17000.
Оппонент B проиграл основной банк и потерял все 2000 – его стек 0, он выбыл. Его фишки (2000) находились в основном банке, который выиграл Hero, поэтому Hero выбил B.
Оппонент A проиграл сайд-пот1 (и основной тоже не получил) – он потерял все 5000, его стек 0, он тоже выбыл. Все его фишки (5000) находились частично в основном банке (2000) и частично в сайд-поте1 (3000) – оба этих банка выиграл Hero. Таким образом Hero выбил A. Hero в этой раздаче выбил двух игроков сразу. Алгоритм должен обнаружить два факта выбивания: Hero причастен к вылету A и к вылету B. Комментарий: Этот пример показывает полный доминирующий выигрыш Hero в мультипоте: у Hero самый большой стек и самая сильная комбинация. Он покрывает и побеждает всех, забирая все банки. Оба оппонента ушли без фишек, и оба были выбиты Hero. Нужно убедиться, что алгоритм идентифицирует каждого выбитого оппонента (даже если их несколько в одной раздаче).
Пример 3: Мультипот префлоп – Hero выбивает одного, другой остаётся
Ситуация: Снова три игрока:
Hero – 10000 фишек,
Оппонент A – 6000 фишек,
Оппонент B – 3000 фишек.
Все трое выставляются префлоп (олл-ин). Банки:
Основной банк: формируется по 3000 от каждого (по размеру наименьшего стека B). Размер = 3000 * 3 = 9000, разыгрывают A, B, Hero.
Сайд-пот 1: оппонент B не участвует (у него 0 после вклада), у A осталось 3000 (от своих 6000), Hero покрывает эти 3000. Сайд-пот = 3000 + 3000 = 6000, разыгрывают A и Hero.
У Hero после этого останется 10000 - 6000 = 4000 невложенных фишек (он не был полностью олл-ин).
Распределение карт (возможный вариант):
У Hero комбинация сильнее, чем у B, но слабее, чем у A.
У A – лучшая комбинация среди троих.
У B – самая слабая.
Результат: Победители по банкам:
Основной банк (9000) – его выигрывает A, т.к. у A самая сильная рука из всех участников основного банка. A получает этот банк и тем самым увеличивает свой стек. (A вложил 3000 и выиграл 9000; его новый стек = 3000 (возвращённые + прибыль) – фактически 9000, но учтём, что он был олл-ин, так что это его итог).
Сайд-пот1 (6000) – разыгрывался между A и Hero, но участие A в сайд-поте было ограничено его оставшимися 3000. Однако поскольку A показал лучшую руку во всей раздаче, он также выигрывает сайд-пот1 в 6000. (Hero проигрывает сайд-пот).
Подсчет итоговых стеков:
Оппонент B вложил 3000 и ничего не выиграл. Его стек = 0, B выбыл.
Оппонент A вложил все 6000, а выиграл 9000 (основной) + 6000 (сайд-пот) = 15000. Его новый стек 15000 (он не выбыл, а наоборот резко вырос).
Hero вложил 6000, не выиграл ни одного банка (оба выиграл A). Hero потерял 6000 и остался с 4000 (не олл-ин, выжил, хотя сильно просел).
Кто выбил B? Основной банк, в который B вложил свои фишки, выиграл оппонент A (именно туда пошли 3000 B). Hero не получил ни одной фишки B, т.к. Hero проиграл все банки. Несмотря на то, что B выбыл в раздаче, выбил его не Hero, а оппонент A. Алгоритм должен отразить, что в этой раздаче Hero никого не выбил (хотя один игрок выбыл, это заслуга другого). Комментарий: Этот пример демонстрирует случай, когда Hero не всегда выбивает всех вылетевших, даже участвуя в олл-ине. Несмотря на то, что оппонент B выбыл, Hero не получил его фишки, поэтому выбивание не засчитывается Hero. Алгоритму важно не просто видеть факт вылета игрока, но и проверять, кто стал обладателем его фишек (в данном случае – не Hero).
Пример 4: Дележка банка ведет к выбиванию (split-pot knockout)
Ситуация: Три игрока на терне идут олл-ин:
Hero – 5000 фишек,
Оппонент A – 5000 фишек,
Оппонент B – 2000 фишек.
Предположим, после торгов:
Основной банк: 2000 * 3 = 6000 (участвуют A, B, Hero).
Сайд-пот: между Hero и A по оставшимся 3000 (т.к. у B только 2000) – сайд-пот = 3000 + 3000 = 6000 (участвуют только Hero и A).
На шоудауне выходит интересная ситуация:
Hero и оппонент A показывают одинаковую комбинацию, например, стрит одной масти, разделившуюся по двум карманным картам (идеальный тузовый стрит у обоих).
Оппонент B показывает более слабую руку.
Результат:
Основной банк (6000): Лучшие комбинации здесь – у Hero и A (они равны между собой и сильнее, чем у B). Поэтому основной банк делится поровну между Hero и A: им начисляется по 3000 фишек. Оппонент B ничего не получает и теряет свои 2000, его стек обнуляется – B выбыл.
Сайд-пот (6000): Сайд-пот разыгрывали только Hero и A, и у них равные руки. Следовательно, сайд-пот тоже делится поровну: по 3000 каждому.
После раздачи:
Hero: был 5000, поставил все, получил 3000 (из основного) + 3000 (из сайд-пота) = 6000. (Слегка увеличил стек).
A: был 5000, поставил все, получил 3000 + 3000 = 6000. (Тоже 6000, на 1000 больше исходного).
B: был 2000, поставил 2000, получил 0 – стек 0, выбыл из турнира.
Кто выбил B? Оппонент B потерял все фишки, и эти 2000 распределились между Hero и A (через основной банк). Оба Hero и A получили часть фишек B, разделив основной банк. Согласно нашему правилу, оба участника раздела банка считаются выбившими B. Hero, в частности, получил 1000 прибыль (вернул свои 2000 из банка и +1000 сверху, частично за счет B), значит Hero выбил оппонента B (совместно с A). Комментарий: В турнирах с баунти (PKO) подобная ситуация обычно приводит к разделению баунти – каждый из победителей получает половину награды за нокаут. Наш алгоритм же в общем случае просто отмечает, что Hero был участником выбивания B. Этот пример показывает, как обрабатывать split-pot: даже если банк поделён, оппонент всё равно выбыл, и раз часть его фишек досталась Hero, выбивание засчитывается.
Пример 5: Выставление на разных улицах, сайд-пот на терне
Ситуация: Четыре игрока на флопе, стеки:
Hero – 8000,
Оппонент A – 3000,
Оппонент B – 5000,
Оппонент C – 5000.
Ход раздачи:
Префлоп: все сделали ставки, допустим, по минимуму, в олл-ин пока никто не пошёл (например, все доставили блайнды, больших ставок не было).
Флоп (банк 1000, по результатам ставок на префлопе, все четверо внесли по 250): Оппонент A (самый короткий стек) пушит оставшиеся 2750 (олл-ин). Hero и B коллируют, оппонент C сбрасывает. Теперь A олл-ин, сформирован основной банк = 2750 (A) + 2750 (Hero) + 2750 (B) + 1000 (с префлопа) = 9250. 
После флопа A больше не участвует (ждет шоудауна), но Hero (5000 осталось) и B (2000 осталось) продолжают сражаться за сайд-пот (который сформируется, если будут ставки на дальнейших улицах).
Тёрн: Hero ставит 5000 (больше, чем у B осталось), оппонент B имеет лишь 2000 и вынужден коллировать олл-ин на 2000. Создается сайд-пот1 = 2000 (Hero) + 2000 (B) = 4000, разыгрываемый между Hero и B. Остальные 3000, которые Hero ставил сверх 2000 B, ему возвращаются (их некому покрыть). Теперь и B олл-ин. (На терне все оставшиеся активные игроки – Hero и B – выставились.)
Ривер: раздача доигрывается открытием ривера без дополнительных ставок (оба оставшиеся игрока уже олл-ин).
Итоги на шоудауне:
У Hero – сильнейшая комбинация среди всех троих.
У B – вторая.
У A – самая слабая.
Распределение выигрышей:
Основной банк (9250, A vs Hero vs B): выигрывает Hero (лучшая рука из всех). Hero забирает этот банк. В основном банке были фишки A и B; особенно важно, что там все 3000 оппонента A. A проиграл и вылетает.
Сайд-пот1 (4000, Hero vs B): выигрывает тоже Hero (его рука лучше, чем у B). Hero забирает и сайд-пот.
После раздачи:
Hero вложил суммарно 250+2750+2000=5000, получил 9250+4000=13250
Анализ выбиваний:
Оппонент A выбыл, его 3000 фишек были в основном банке, который выиграл Hero. Hero выбил A.
Оппонент B выбыл, его фишки 3000 (в основном банке) и 2000 (в сайд-поте) все достались Hero (Hero выиграл и основной банк, и сайд-пот1). Hero выбил B.
Hero, показав лучшую комбинацию, забрал все банки, выбив двух игроков. Этот пример иллюстрирует последовательные выставления: A был выбит на флопе (фактически после шоудауна), B – на терне. Алгоритм должен корректно отследить оба олл-ина и определить, что оба оппонента потеряли свои стеки, а победителем соответствующих банков в обоих случаях был Hero. (Для полноты можно представить альтернативный исход: допустим, у B на шоудауне оказалась лучшая рука. Тогда: B выиграл основной банк (9000) – спас себя и получил фишки, A выбыл (его фишки ушли к B), сайд-пот (4000) выиграл тоже B. Hero никого не выбил. Этот альтернативный исход наш алгоритм тоже правильно обработает)
Пример 6: Авто-олл-ин на префлопе
Ситуация: В турнире блайнды 1000/2000, 3 игрока за столом, Hero на BTN.  У оппонента BB перед раздачей всего 500 фишек. анте 100 фишек.  Он сидит на большом блайнде (2000), но у него недостаточно фишек – он автоматически ставит все 500 (это все, что у него есть) - 100 в анте и 400 в BB. Это считается олл-ином на префлопе: оппонент на BB участвует в раздаче только с 500 фишками. Остальные игроки видят, что big blind неполный:
Hero (на BTN) делает рейз до 4000 и игрок на SB фолдит (но он автоматически проставил 100 анте и 1000 small blind).

Банки:
Основной банк: по 500 от каждого из троих (1500). Несмотря на то, что игрок на SB автоматически (ante + small blind) внес в банк достаточно, чтобы претендовать на нокаут за игрока на BB, он сфолдил и утратил на это право. Теперь на нокаут претендует только Hero.
Сайд-пот: Поскольку игрок на SB сфолдил в ответ на опен-рейз Hero с BTN, то излишние 3000 от ставки Hero были ему возвращены и в банк эффективно Hero внес 1000 (размер sb) + 100 анте. = 1100. 500 из них ушли в основной банк и 600 в сайд пот с SB, который Hero забирает автоматически, посколько игрок на SB сфолдил. Сайд-пот равен 1200 (по 600 от SB и Hero). 
Результат: Карты вскрываются (Hero и BB, поскольку BB олл-ин):
Если Hero выигрывает этот банк (например, у Hero комбинация сильнее), он получает 1500 фишек (основной банк). Оппонент на BB теряет свои 500, стек 0 – выбыл. Hero получил фишки игрока на BB, значит Hero выбил его.
Если бы игрок на BB выиграл, он бы получил эти 1500, никто бы не выбыл. Hero не получает нокаут. 
Комментарий: иногда игрок с очень маленьким стеком может оказаться в авто-олл-ине и на свободной позиции (UTG-BTN), если его стек <= размеру анте, которое он должен будет проставить в начале раздачи. 